# Requires Docker Compose v2
name: dlp-selfdeposit
services:
  worker:
    image: emorylibraries/self_deposit
    command: sh -c 'bundle exec sidekiq'
    user: root
    stdin_open: true
    tty: true
    env_file:
      - .env.production
    depends_on:
      - db_migrate
    volumes:
      - .:/app
      - nfs-uploads:/opt/uploads
      - bundle:/app/bundle
      - hyrax-storage:/app/storage
      - hyrax-derivatives:/app/derivatives
      - hyrax-uploads:/app/uploads
      - rails-public:/app/public
      - rails-tmp:/app/tmp
    networks:
      - dlp

  db_migrate:
    image: emorylibraries/self_deposit
    user: root
    env_file:
      - .env.production
    command: ./scripts/db-migrate-seed.sh
    volumes:
      - .:/app
      - bundle:/app/bundle
      - rails-public:/app/public
      - rails-tmp:/app/tmp
    networks:
      - dlp

  fits:
    image: ghcr.io/samvera/fitsservlet:1.6.0
    ports:
      - 9082:8080
    networks:
      - dlp

volumes:
  bundle:
  hyrax-storage:
  hyrax-derivatives:
  hyrax-uploads:
  rails-public:
  rails-tmp:
  nfs-uploads:
    driver: local
    driver_opts:
      type: nfs
      o: "addr=${NFS_SERVER_IP},nolock,soft,rw"
      device: ":/opt/uploads"

networks:
  dlp:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-dlp
